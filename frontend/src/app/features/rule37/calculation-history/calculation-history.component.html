<div class="history-container">
    @if (loading()) {
    <div class="loading-state">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
        <p>Loading saved calculations...</p>
    </div>
    } @else if (error()) {
    <div class="error-state">
        <i class="pi pi-exclamation-circle"></i>
        <p>{{ error() }}</p>
        <button pButton label="Retry" icon="pi pi-refresh" (click)="loadRuns()"></button>
    </div>
    } @else if (runs().length === 0) {
    <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <h3>No Saved Calculations</h3>
        <p>Your calculation history will appear here once you upload ledger files.</p>
    </div>
    } @else {

    <!-- Viewing a run detail -->
    @if (viewingRun()) {
    <div class="run-detail">
        <div class="detail-header">
            <button pButton icon="pi pi-arrow-left" label="Back to History" class="p-button-text"
                (click)="viewingRun.set(null)"></button>
            <span class="detail-date">{{ formatDate(viewingRun()!.createdAt) }}</span>
        </div>
        <app-compliance-view [results]="normalizeResults(viewingRun()!.calculationData)" [runId]="viewingRun()!.id"
            [showExportAll]="true"
            (exportAll)="downloadExport(viewingRun()!.id, viewingRun()!.calculationData[0]?.ledgerName || 'export')"
            (exportLedger)="onExportLedger($event, viewingRun()!.id, viewingRun()!.calculationData[0]?.ledgerName || 'export')" />
    </div>
    } @else {

    <!-- Run list -->
    <div class="history-list">
        @for (run of runs(); track run.id) {
        <div class="history-card">
            <div class="card-main" (click)="viewingRun.set(run)">
                <div class="card-icon">
                    <i class="pi pi-calculator"></i>
                </div>
                <div class="card-content">
                    <div class="card-title">
                        @if (run.calculationData.length === 1) {
                        {{ run.calculationData[0].ledgerName }}
                        } @else {
                        {{ run.calculationData[0].ledgerName }} +{{ run.calculationData.length - 1 }} more
                        }
                    </div>
                    <div class="card-meta">
                        <span class="meta-date">{{ formatDate(run.createdAt) }}</span>
                        <span class="meta-sep">â€¢</span>
                        <span class="expiry-badge" [class.expiry-critical]="getDaysRemaining(run.expiresAt) <= 1"
                            [class.expiry-warning]="getDaysRemaining(run.expiresAt) <= 3 && getDaysRemaining(run.expiresAt) > 1">
                            <i class="pi pi-clock"></i> {{ getDaysRemaining(run.expiresAt) }}d remaining
                        </span>
                    </div>
                    <div class="card-summary">
                        <span>ITC Reversal: <strong>{{ formatCurrency(run.totalItcReversal || 0) }}</strong></span>
                        <span>Interest: <strong>{{ formatCurrency(run.totalInterest || 0) }}</strong></span>
                    </div>
                </div>
            </div>
            <div class="card-actions">
                <button pButton icon="pi pi-download" pTooltip="Export" class="p-button-text p-button-rounded"
                    (click)="downloadExport(run.id, run.calculationData[0]?.ledgerName || 'export'); $event.stopPropagation()"></button>
                <button pButton icon="pi pi-trash" pTooltip="Delete"
                    class="p-button-text p-button-rounded p-button-danger"
                    (click)="deleteRun(run.id); $event.stopPropagation()"></button>
            </div>
        </div>
        }
    </div>

    @if (totalRecords() > 0) {
    <div class="mt-4">
        <p-paginator [first]="currentPage() * pageSize()" [rows]="pageSize()" [totalRecords]="totalRecords()"
            [rowsPerPageOptions]="[10, 20, 50]" (onPageChange)="onPageChange($event)">
        </p-paginator>
    </div>
    }
    }
    }
</div>